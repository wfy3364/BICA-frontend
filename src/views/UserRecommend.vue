<template>
    <div>
        <el-card class="box-card">
            <template #header>
                <div class="card-header">
                <span>Êñ∞ÈóªÁöÑÁî®Êà∑‰∏™ÊÄßÂåñÊé®Ëçê</span>
                </div>
            </template>
            <el-tabs v-model="activeTab">
                <el-tab-pane label="‰Ωú‰∏∫Â∑≤ÊúâÁî®Êà∑" name="existing">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div>Êü•Áúã‰∏∫Â∑≤ÊúâÁî®Êà∑Êé®ËçêÁöÑÊñ∞Èóª</div>
                        <div style="display: flex; align-items: center;">
                            <span style="margin-right: 10px;">Áî®Êà∑idÔºö</span>
                            <el-input v-model="userId" placeholder="Áî®Êà∑id" class="id-input" />
                            <el-button type="primary" @click="userRecommend">GOÔºÅ</el-button>
                        </div>
                        <div v-if="showLists" style="display: flex; gap: 20px; margin-top: 20px;">
                            <!-- Â∑¶‰æßÔºöÂéÜÂè≤ËÆ∞ÂΩï -->
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 8px;">ÂéÜÂè≤ËÆ∞ÂΩï</div>
                                <el-table v-if="userHistory && userHistory.length > 0" :data="userHistory" size="small" style="width: 100%;">
                                    <el-table-column prop="news_id" label="id" width="100" />
                                    <el-table-column prop="title" label="Ê†áÈ¢ò" width="400"/>
                                    <el-table-column prop="category" label="Á±ªÂà´" width="150"/>
                                    <el-table-column prop="dwell" label="ÂÅúÁïôÊó∂Èïø" width="180"/>
                                </el-table>
                                <div v-else style="color: #aaa;">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>
                            </div>
                            <!-- Âè≥‰æßÔºöÊé®ËçêÂàóË°® -->
                            <div style="flex: 1; display: flex; flex-direction: column; height: 100%;">
                                <div style="font-weight: bold; margin-bottom: 8px;">Êé®ËçêÊñ∞Èóª</div>
                                <el-table v-if="recommendations && recommendations.length > 0" :data="recommendations" size="small" style="width: 100%;">
                                    <el-table-column prop="title" label="Ê†áÈ¢ò" />
                                    <el-table-column prop="nearest_history" label="ÂèØËÉΩÁöÑÊé®Ëçê‰æùÊçÆ" width="150"/>
                                    <el-table-column label="ËøëÊúüÁÉ≠Â∫¶" width="150">
                                        <template #default="scope">
                                            <span v-if="typeof scope.row.temperature_48h === 'number'">
                                                <template v-if="scope.row.temperature_48h > 200">üî•üî•üî•</template>
                                                <template v-else-if="scope.row.temperature_48h > 50">üî•üî•</template>
                                                <template v-else-if="scope.row.temperature_48h > 10">üî•</template>
                                                <template v-else>-</template>
                                            </span>
                                            <span v-else>-</span>
                                        </template>
                                    </el-table-column>

                                </el-table>
                                <div v-else style="color: #aaa;">ÊöÇÊó†Êé®Ëçê</div>
                            </div>
                        </div>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="‰Ωú‰∏∫Êñ∞Áî®Êà∑Ê®°ÊãüÊµèËßà" name="browse">
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div>Êñ∞Áî®Êà∑Ê®°ÊãüÊµèËßà</div>
                        <el-button type="primary" style="width: 120px; margin-bottom: 10px;" @click="newUserRecommend">‰ª•UtestË∫´‰ªΩËé∑ÂèñÊé®Ëçê</el-button>
                        <div v-if="showNewUserLists" style="display: flex; gap: 20px; margin-top: 20px;">
                            <!-- Â∑¶‰æßÔºöÂéÜÂè≤ËÆ∞ÂΩï -->
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;">
                                    ÂéÜÂè≤ËÆ∞ÂΩï
                                    <el-button size="small" type="danger" style="margin-left: 10px;" @click="clearNewUserHistory">Ê∏ÖÁ©∫</el-button>
                                </div>
                                <el-table v-if="newUserHistory && newUserHistory.length > 0" :data="newUserHistory" size="small" style="width: 100%;">
                                    <el-table-column prop="title" label="Ê†áÈ¢ò" />
                                </el-table>
                                <div v-else style="color: #aaa;">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</div>
                            </div>
                            <!-- Âè≥‰æßÔºöÊé®ËçêÂàóË°® -->
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 8px;">Êé®ËçêÊñ∞Èóª</div>
                                <el-table v-if="newUserRecommendations && newUserRecommendations.length > 0" :data="newUserRecommendations" size="small" style="width: 100%;">
                                    <el-table-column prop="title" label="Ê†áÈ¢ò" />
                                    <el-table-column label="ËøëÊúüÁÉ≠Â∫¶" width="150">
                                        <template #default="scope">
                                            <span v-if="typeof scope.row.temperature_48h === 'number'">
                                                <template v-if="scope.row.temperature_48h > 200">üî•üî•üî•</template>
                                                <template v-else-if="scope.row.temperature_48h > 50">üî•üî•</template>
                                                <template v-else-if="scope.row.temperature_48h > 10">üî•</template>
                                                <template v-else>-</template>
                                            </span>
                                            <span v-else>-</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="ÂñúÊ¨¢ÂêóÔºü">
                                        <template #default="scope">
                                            <el-button size="small" type="primary" :disabled="scope.row.liked" @click="handleNewUserRecommendClick(scope.row)">
                                                {{ scope.row.liked ? 'ÂñúÊ¨¢Â∞±Â•Ω UwU ' : 'ÂñúÊ¨¢Ëøô‰∏™ÔºÅ' }}
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                                <div v-else style="color: #aaa;">ÊöÇÊó†Êé®Ëçê</div>

                                <!-- ÈöèÊú∫Êñ∞ÈóªÂå∫Âüü -->
                                <div style="margin-top: 30px;">
                                    <div style="font-weight: bold; margin-bottom: 8px; display: flex; align-items: center;">
                                        ÈöèÊú∫Êñ∞Èóª
                                        <el-button size="small" type="success" style="margin-left: 10px;" @click="fetchNewUserRandomNews">Âà∑Êñ∞</el-button>
                                    </div>
                                    <el-table v-if="newUserRandomNews && newUserRandomNews.length > 0" :data="newUserRandomNews" size="small" style="width: 100%;">
                                        <el-table-column prop="title" label="Ê†áÈ¢ò" />
                                        <el-table-column label="ËøëÊúüÁÉ≠Â∫¶" width="150">
                                            <template #default="scope">
                                                <span v-if="typeof scope.row.temperature_48h === 'number'">
                                                    <template v-if="scope.row.temperature_48h > 200">üî•üî•üî•</template>
                                                    <template v-else-if="scope.row.temperature_48h > 50">üî•üî•</template>
                                                    <template v-else-if="scope.row.temperature_48h > 10">üî•</template>
                                                    <template v-else>-</template>
                                                </span>
                                                <span v-else>-</span>
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="ÂñúÊ¨¢ÂêóÔºü">
                                            <template #default="scope">
                                                <el-button size="small" type="primary" :disabled="scope.row.liked" @click="handleNewUserRecommendClick(scope.row)">
                                                    {{ scope.row.liked ? 'ÂñúÊ¨¢Â∞±Â•Ω UwU ' : 'ÂñúÊ¨¢Ëøô‰∏™ÔºÅ' }}
                                                </el-button>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                    <div v-else style="color: #aaa;">ÊöÇÊó†ÈöèÊú∫Êñ∞Èóª</div>
                                </div>
                                <!-- ÈöèÊú∫Êñ∞ÈóªÂå∫ÂüüÁªìÊùü -->
                            </div>
                        </div>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="ÂêëÈáèËØ≠‰πâÊêúÁ¥¢" name="search">
                    <div style="display: flex; align-items: center;">
                        <span style="margin-right: 10px;">‰Ω†ÊÉ≥Áúã‰ªÄ‰πàÊñ∞ÈóªÔºü</span>
                        <el-input v-model="searchQuery" placeholder="ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÜÖÂÆπ" class="id-input" />
                        <el-button type="primary" @click="smartSearch">ÊêúÁ¥¢</el-button>
                    </div>
                    <el-table v-if="searchResults.length > 0" :data="searchResults" style="width: 100%; margin-top: 20px;">
                        <el-table-column prop="news_id" label="id" width="80" />
                        <el-table-column prop="title" label="Ê†áÈ¢ò" />
                        <el-table-column prop="cosine_distance" label="Áõ∏‰ººÂ∫¶" />
                        <el-table-column prop="temperature_48h" label="ËøëÊúüÁÉ≠Â∫¶" />
                    </el-table>
                    <div v-else-if="searchLoading" style="color: #aaa; margin-top: 20px;">ÊêúÁ¥¢‰∏≠...</div>
                    <div v-else-if="searchNoResult" style="color: #aaa; margin-top: 20px;">ÊöÇÊó†ÁªìÊûú</div>
                </el-tab-pane>
            </el-tabs>

            <el-divider></el-divider>

            
        </el-card>
    </div>
</template>
  
<script setup>
import { ref } from 'vue';
import { ElMessage } from 'element-plus';

const activeTab = ref('existing');
const userId = ref('');
const recommendations = ref([]);
const userHistory = ref([]);
const showLists = ref(false);

const newUserHistory = ref([]);
const newUserRecommendations = ref([]);
const showNewUserLists = ref(true);

const newUserRandomNews = ref([]);

const searchQuery = ref('');
const searchResults = ref([]);
const searchLoading = ref(false);
const searchNoResult = ref(false);

function userRecommend() {
    if(userId.value.length==0){
        ElMessage.error('Áî®Êà∑id‰∏çËÉΩ‰∏∫Á©∫');
        return;
    }
    // ËØ∑Ê±ÇÂêéÁ´ØÊé®ËçêÊé•Âè£ÔºàÂ∑≤ÊúâÁî®Êà∑Ôºâ
    fetch(`http://127.0.0.1:5000/api/recommend/user?user_id=${encodeURIComponent(userId.value)}&topk=20`)
        .then(res => res.json())
        .then(data => {
            if (Array.isArray(data)) {
                recommendations.value = data;
                showLists.value = true;
            } else {
                ElMessage.error(data.error || 'Ëé∑ÂèñÊé®ËçêÂ§±Ë¥•');
            }
        })
        .catch(() => {
            ElMessage.error('Ëé∑ÂèñÊé®ËçêÂ§±Ë¥•');
        });
    // ËØ∑Ê±ÇÁî®Êà∑ÂéÜÂè≤
    fetch(`http://127.0.0.1:5000/api/recommend/user/history?user_id=${encodeURIComponent(userId.value)}`)
        .then(res => res.json())
        .then(data => {
            if (Array.isArray(data)) {
                userHistory.value = data;
            } else {
                userHistory.value = [];
            }
        })
        .catch(() => {
            userHistory.value = [];
        });
}

function newUserRecommend() {
    const newUserId = 'Utest';
    fetch(`http://127.0.0.1:5000/api/recommend/user?user_id=${encodeURIComponent(newUserId)}&topk=20`)
        .then(res => res.json())
        .then(data => {
            if (Array.isArray(data)) {
                newUserRecommendations.value = data;
                showNewUserLists.value = true;
            } else {
                ElMessage.error(data.error || 'Ëé∑ÂèñÊé®ËçêÂ§±Ë¥•');
            }
        })
        .catch(() => {
            ElMessage.error('Ëé∑ÂèñÊé®ËçêÂ§±Ë¥•');
        });
    fetch(`http://127.0.0.1:5000/api/recommend/user/history?user_id=${encodeURIComponent(newUserId)}`)
        .then(res => res.json())
        .then(data => {
            if (Array.isArray(data)) {
                newUserHistory.value = data;
            } else {
                newUserHistory.value = [];
            }
        })
        .catch(() => {
            newUserHistory.value = [];
        });
}

function clearNewUserHistory() {
    // Ë∞ÉÁî®ÂêéÁ´ØÊé•Âè£Ê∏ÖÁ©∫Êñ∞Áî®Êà∑ÂéÜÂè≤
    fetch('http://127.0.0.1:5000/api/recommend/clear?user_id=Utest', {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
            newUserHistory.value = [];
            ElMessage.success('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
    })
}

async function handleNewUserRecommendClick(row) {
    try {
        const res = await fetch(`http://127.0.0.1:5000/api/recommend/click?news_id=${encodeURIComponent(row.news_id)}`);
        const data = await res.json();
        if (res.ok) {
            row.liked = true;
            ElMessage.success(`Ê®°ÊãüÁî®Êà∑Â∑≤ÈòÖËØªÔºö${row.title}`);
            // ÂèØÈÄâÔºöÂà∑Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï
            newUserRecommend();
        } else {
            ElMessage.error(data.error || 'ÁÇπÂáªÂ§±Ë¥•');
        }
    } catch (e) {
        ElMessage.error('ÁÇπÂáªÂ§±Ë¥•');
    }
}

async function fetchNewUserRandomNews() {
    try {
        const res = await fetch('http://127.0.0.1:5000/api/recommend/random');
        const data = await res.json();
        if (Array.isArray(data)) {
            newUserRandomNews.value = data.map(item => ({ ...item, liked: false }));
        } else {
            newUserRandomNews.value = [];
        }
    } catch (e) {
        newUserRandomNews.value = [];
        ElMessage.error('Ëé∑ÂèñÈöèÊú∫Êñ∞ÈóªÂ§±Ë¥•');
    }
}

function handleNewUserRandomLike(row) {
    setTimeout(() => {
        row.liked = true;
        ElMessage.success(`ÂñúÊ¨¢‰∫ÜÈöèÊú∫Êñ∞ÈóªÔºö${row.title}`);
    }, 500);
}

async function smartSearch() {
    if (!searchQuery.value) {
        ElMessage.warning('ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÜÖÂÆπ');
        return;
    }
    searchLoading.value = true;
    searchNoResult.value = false;
    searchResults.value = [];
    try {
        // ÂÆûÈôÖÂêéÁ´ØAPIËØ∑Ê±Ç
        const res = await fetch(`http://127.0.0.1:5000/api/recommend/search?target_title=${encodeURIComponent(searchQuery.value)}`);
        if (!res.ok) throw new Error('ÊêúÁ¥¢Â§±Ë¥•');
        const data = await res.json();
        searchResults.value = data;
        searchNoResult.value = data.length === 0;
    } catch (e) {
        searchNoResult.value = true;
        ElMessage.error('ÊêúÁ¥¢Â§±Ë¥•');
    } finally {
        searchLoading.value = false;
    }
}
</script>


<style scoped>
.card-header {
    font-size: 18px;
    font-weight: bold;
}

.id-input {
    width: 300px;
    margin-right: 10px;
}

:deep(.el-table__body), :deep(.el-table__header) {
    font-size: 18px;
}
</style>